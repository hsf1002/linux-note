### 第22章 信号：高级特性

##### 核心转储文件

特定信号会引发进程创建一个核心转储文件并终止运行，核心转储文件时内含进程终止时内存映像的文件（core是一种老迈的内存技术），通常是键入退出符（Control + \）而生成SIGQUIT信号，Linux下可以使用gdb连接一个正在运行的进程，使用gcore命令获取其core文件

不产生核心转储文件的情况：

* 进程对核心转储文件没有写权限（默认是进程当前工作目录）
* 存在一个同名、可写的普通文件，但指向该文件的（硬）链接数超过一个
* 将要创建的核心转储文件所在目录不存在
* 把进程核心转储文件大小的资源限制（RLIMIT_CORE）置为0，shell下可通过ulimit设置
* 将进程可创建文件的大小的资源限制（RLIMIT_FSIZE）置为0
* 对进程正在执行的二进制可执行文件没有读权限（防止借助核心转储文件获取程序代码）
* 以只读方式挂载当前工作目录的文件系统，或文件系统空间已满，又或者i-node资源耗尽
* set-user-ID（set-group-ID）程序在由非文件属主（或属组）执行时，不会产生核心转储文件（借助于Linux专有调用prctl的PR_SET_DUMPABLE操作，可为进程设置dumpable标志，当非文件属主运行set-user-ID（set-group-ID）程序时，即可产生核心转储文件）

Linux特有的/proc/PID/coredump_filter，可以对写入核心转储文件的内存映射类型施以进程级控制，有4种内存映射：私有匿名映射、私有文件映射、共享匿名映射、共享文件映射，文件默认值提供了传统的Linux行为：仅对私有匿名映射和共享匿名映射进行转储

Linux特有的/proc/sys/kernel/core_pattern，可用格式化字符串为核心转储文件重命名，其默认名是core

```
%c  文件大小的资源软限制
%e  可执行文件名
%g  遭转储进程的实际组ID
%h  主机系统的名称
%p  遭转储进程的进程ID
%s  导致进程终止的信号编号
%t  转储时间
%u  遭转储进程的实际用户ID
%%  单个%字符
```

