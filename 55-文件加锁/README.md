## 第55章 文件加锁

### 概述

虽然使用信号量可以完成同步，通常使用文件锁更好，因为内核能够自动将锁与文件关联起来，两种文件锁API：

* flock对整个文件加锁，源自BSD
* fcntl对一个文件区域加锁，源自System V

虽然文件锁通常与文件IO一起使用，但可以作为一项更为通用的同步技术

##### 混合使用文件锁和stdio函数

由于stdio库会在用户空间进行缓冲，在混合使用stdio函数与加锁技术时需谨慎，可以采用如下方式：

* 使用read/write取代stdio库函数执行文件IO
* 对文件加锁之后立即刷新stdio库，且在释放锁之前立即再次刷新这个流
* 使用setbuf禁用stdio缓冲

##### 劝告式和强制式加锁

* 劝告式：默认，表示一个进程可以简单地忽略另一个进程在文件上放置的锁
* 强制式：强制一个进程执行IO时要遵循其他进程持有的锁

