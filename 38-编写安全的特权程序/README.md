## 第38章 编写安全的特权程序

### 是否需要一个set-user-id或set-group-id程序

一个程序可以通过两种方式以特权方式运行：

* 程序在特权用户ID下启动，很多daemon程序都是以root身份启动并运行
* 程序设置了set-user-ID或set-group-ID权限位，当此程序被执行时，它会将进程的有效用户ID（组）修改为程序的所有者（组）

尽量避免编写此类程序

假如一个set-user-ID程序需要更新一个它没有写权限的程序，更加安全的方式是创建一个专用组账号（组ID），将文件所属的组修改为那个组，接着编写一个将进程的有效组ID设置为该专用组ID的set-user-ID程序，由于这个专用组ID没有其他权限位，能够极大的限制程序包含bug或被破坏时造成的损失

### 以最小权限操作

##### 按需拥有权限

```
uid_t orig_euid;

orig_euid = geteuid();
// 放弃权限：将有效用户ID改为真实用户ID
if (-1 == seteuid(getuid()))
    perror("seteuid error");
// 重获权限：将有效用户ID还原为saved set-user-ID
    if (-1 == seteuid(orig_euid))
perror("seteuid error");
```

最安全的做法是在程序启动的时候立刻删除权限，后面需要的时候临时重新获取权限

##### 无需使用时永久的删除权限

通过将进程用户（组）ID重置为真实（组）ID完成

##### 修改进程身份信息的注意事项

* Linux上，使用setresuid、setresgid修改用户和组身份信息
* 即使调用者的有效用户ID为0，修改身份信息的系统调用在程序显式的操作其能力时可能表现出意料之外的行为，如禁用CAP_SETUID能力，修改进程用户ID将失败
* 实践中，不仅要检查修改身份信息的系统调用是否成功，还需验证修改行为是否达到预期
* 一些身份信息的变更只能由有效用户ID为0的进程完成