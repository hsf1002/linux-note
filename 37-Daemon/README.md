## 第37章 Daemon

### 概述

守护进程的特征：

* 生命周期很长，一般在系统启动时创建直到系统关闭
* 后台运行且不拥有控制终端，内核永远不会为守护进程生成任何任务控制信号和终端相关信号

常见的守护进程：

cron：规定时间内执行命令的程序

sshd：允许在远程主机使用一个安全的通信协议登录系统

httpd：HTTP的服务器程序

inetd：Internet超级服务器程序，监听从指定的TCP/IP端口上进入的网络连接

pdflush：定期将脏页面（即高速缓冲区的页面）写入磁盘

### 创建一个daemon

1. 执行一个fork，之后父进程退出，子进程继续执行，这样daemon会成为init的子进程
2. 子进程调用setsid，开启一个新会话并释放它与控制终端之间的所有关联
3. 如果daemon后续可能打开一个终端设备，需确保这个设备不会变成控制终端，有两个方法
   * open的调用中指定O_NOCTTY标记
   * setsid之后执行第二个fork，再次让父进程退出，并让子进程继续执行，这样子进程不会成为会话组长，从而不会重新请求一个控制终端

4. 清除进程的umask
5. 修改进程的当前工作目录，通常会更改为根目录/
6. 关闭daemon从父进程继承而来的所有打开的文件描述符
7. 关闭文件描述符0、1、2后，打开/dev/null（一个虚拟设备，总是将写入的数据丢弃），并使用dup2使得这三个描述符指向这个设备，原因：
   * 确保daemon调用了在这些描述符上执行IO的库函数时不会失败
   * 防止daemon后面使用1、2打开一个文件的情况

