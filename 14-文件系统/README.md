### 第14章 文件系统

##### 设备专有文件

* 字符型设备：基于字符处理数据，如终端和键盘
* 块设备：每次处理一块数据，一般都是512字节，如磁带和磁盘

通常位于/dev下，超级用户可以使用mknod命令创建设备文件，特权程序可通过mknod()系统调用实现相同功能，udev程序所依赖的sysfs文件系统，是装载于/sys下的伪文件系统，将设备和其他内核对象的相关信息导出到用户空间

每个设备都有主、辅ID号，主ID标识一般的设备等级，内核会根据主ID查找对应的驱动程序，辅ID能够在同一等级中标识唯一特定设备，命令ls -l可显示出设备文件的主辅ID，每个设备的驱动程序都会将自己与特定主设备号的关联关系向内核注册，以此建立设备专用文件和设备驱动程序之间的关系，内核是不会使用设备文件名查找驱动程序的

##### 磁盘和分区

磁盘驱动器是一种机械装置，由一个或多个高速旋转的盘片组成，通过在磁盘上快速移动读写磁头，可获取/修改磁盘表面的磁性编码信息，磁盘表面信息物理上存储于磁道的一组同心圆上，其又被划分为若干扇区，每个扇区包括一系列物理块，物理块的容量一般是512字节，代表驱动器可以读写的最小信息单元。首先磁头要移动到相应的磁道（寻道时间），然后再相应扇区旋转到磁头下之前，驱动器必须一直等待（旋转延迟），最后还要从所请求的块上传输数据（传输时间），上述操作通常以毫秒计数

每个磁盘可划分为多个分区，内核视每个分区为/dev下的单独设备，系统管理员使用fdisk决定磁盘分区的编号、大小和类型，fdisk -l会列出磁盘上所有分区，Linux专有文件/proc/partitions记录了系统中每个磁盘分区的主副设备编号、大小和名称，磁盘分区可容纳任何类型的信息，通常只包含以下之一：

* 文件系统：用来存放常规文件
* 数据区域：作为裸设备对其进行访问
* 交换区域：供内核的内存管理使用

mkswap命令可创建交换区域，特权进程可用swapon系统调用向内核报告将磁盘分区用作交换区域，swapoff系统调用执行相反功能，即告知内核停止将磁盘分区作为交换区域，可使用Linux专有文件/proc/swaps查看系统中当前以及激活的交换区域的信息

##### 文件系统

文件系统时对常规文件和目录的组织集合，创建文件系统的命令式mkfs，Linux支持种类繁多的文件系统

* 传统的ext2文件系统
* 原生UNIX文件系统，如Minix、System V、BSD
* 微软的FAT、FAT32、NTFS
* ISO CD-ROM文件系统
* Apple Macintosh的HFS
* 一系列日志文件系统，如ext3、ext4、Reiserfs、JFS、XFS、Btrfs

Linux专有的文件/proc/filesystems可以查看当前内核所识别的文件系统类型

ext2随着日志文件系统的兴起，使用日趋减少，但其概念较为通用，文件系统的组成部分：

* 引导块：总是作为文件系统的首块，不为文件系统使用，只是包含用来引导操作系统的信息
* 超级块：紧随引导块的一个独立块，包含与文件系统有关的参数信息，如i节点容量、文件系统中逻辑块大小，文件系统的大小等
* i节点表：记录着文件系统中每个文件与目录
* 数据块：文件系统中大部分空间都用于存放数据

##### i节点

文件的i节点号是ls -li命令所显示的第一列：

```
skydeiMac:14-文件系统 sky$ ls -li
7217991 -rw-r--r--@ 1 sky  staff  3582 11 17 08:33 README.md
```

i节点主要维护如下信息：

* 文件类型
* 文件属主
* 文件属组
* 3类用户的访问权限
* 3个时间戳：最后访问时间（ls -lu）、最后修改时间（ls -l）、文件状态的最后改变时间（ls -lc），一般不会记录文件的创建时间
* 指向文件的硬链接数量
* 文件的大小，字节为单位
* 实际分配给文件的块数量，512字节为单位，不会简单的等于文件大小，因为要考虑文件中可能包含空洞
* 指向文件数据块的指针

![image-20191117083853328](/Users/sky/Library/Application Support/typora-user-images/image-20191117083853328.png)

无需连续存储文件块，使得文件系统对磁盘空间利用更为高效，当然导致文件碎片化比较严重

4个层级的索引设计为了满足多重意图：维持i节点结构大小固定的同时，支持任意大小的文件；文件系统既可以不连续方式存储，又可以通过lseek随机访问，内核只需计算移动的指针；对于占绝对多数的小文件而言，满足了对文件数据块的快速访问；该设计的另一个优点是文件可以有黑洞，文件系统只需将i节点和间接指针块中的相应指针打上标记（值为0），表明这些指针并未指向实际的磁盘块即可，无需为文件黑洞分配字节数据块

##### 虚拟文件系统

- VFS针对文件系统定义了一套通用接口
- 每个文件系统都会提供VFS接口的实现

VFS接口包括：open、read、write、lseek、close、truncate、stat、mount、unmount、mmap、mkdir、link、unlink、symlink、rename

